---
title: "STAT510_Project"
author: "Nicholas Roy"
date: "4/22/2020"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

```

```{r, echo=FALSE} 
pkgs = c("alr4","rmarkdown", "faraway", "datasets", "sos", "car", "plotly", "ggplot2", "tidyverse", "broom", "SemiPar", "RegularExpressions","GGally")
new.packages = pkgs[!(pkgs %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

library(GGally)
library(ggplot2)
```

```{r}
##Working Directory
#setwd("C:\Users\mnhale\OneDrive - Urban Science\STATS\Spring 2020\STAT 510\covidanalysis\project")

#setwd("C:/Users/Nicho/OneDrive/2_Mathematics/School/courses/STAT510_intro_regression_analysis/project/github/covidanalysis/project")
```


```{r}
#raw datasets

casesanddeaths = read.csv(file = "csvs/us-counties.csv")
data_health = read.csv(file = "csvs/us-county-health-rankings-2020.csv")
data_mobility = read.csv(file = "csvs/us-mobility.csv")

data_mobility$county = stringr::str_remove(data_mobility$region, " County")

```

```{r}

CD_mobility = merge(x = casesanddeaths, y = data_mobility, all.x = TRUE, by = c("county", "state"))
allmerged = merge(x=CD_mobility, y = data_health, all.x = TRUE, by = "fips")
head(allmerged)

```

```{r}

CD_cov19.0324 = CD_mobility[ which(CD_mobility$date.x=='2020-03-24'), ]
CD_cov19.0329 = CD_mobility[ which(CD_mobility$date.x=='2020-03-29'), ]
CD_cov19.0330 = CD_mobility[ which(CD_mobility$date.x=='2020-03-30'), ]
CD_cov19.0331 = CD_mobility[ which(CD_mobility$date.x=='2020-03-31'), ]
CD_cov19.0401 = CD_mobility[ which(CD_mobility$date.x=='2020-04-01'), ]
CD_cov19.0402 = CD_mobility[ which(CD_mobility$date.x=='2020-04-02'), ]
CD_cov19.0403 = CD_mobility[ which(CD_mobility$date.x=='2020-04-03'), ]
CD_cov19.0404 = CD_mobility[ which(CD_mobility$date.x=='2020-04-04'), ]
CD_cov19.0405 = CD_mobility[ which(CD_mobility$date.x=='2020-04-05'), ]
CD_cov19.0406 = CD_mobility[ which(CD_mobility$date.x=='2020-04-06'), ]
CD_cov19.0407 = CD_mobility[ which(CD_mobility$date.x=='2020-04-07'), ]
CD_cov19.0408 = CD_mobility[ which(CD_mobility$date.x=='2020-04-08'), ]
CD_cov19.0409 = CD_mobility[ which(CD_mobility$date.x=='2020-04-09'), ]
CD_cov19.0410 = CD_mobility[ which(CD_mobility$date.x=='2020-04-10'), ]
CD_cov19.0411 = CD_mobility[ which(CD_mobility$date.x=='2020-04-11'), ]
CD_cov19.0412 = CD_mobility[ which(CD_mobility$date.x=='2020-04-12'), ]
CD_cov19.0413 = CD_mobility[ which(CD_mobility$date.x=='2020-04-13'), ]
CD_cov19.0414 = CD_mobility[ which(CD_mobility$date.x=='2020-04-14'), ]
CD_cov19.0415 = CD_mobility[ which(CD_mobility$date.x=='2020-04-15'), ]
CD_cov19.0416 = CD_mobility[ which(CD_mobility$date.x=='2020-04-16'), ]
CD_cov19.0417 = CD_mobility[ which(CD_mobility$date.x=='2020-04-17'), ]
CD_cov19.0418 = CD_mobility[ which(CD_mobility$date.x=='2020-04-18'), ]
CD_cov19.0419 = CD_mobility[ which(CD_mobility$date.x=='2020-04-19'), ]
CD_cov19.0420 = CD_mobility[ which(CD_mobility$date.x=='2020-04-20'), ]
CD_cov19.0421 = CD_mobility[ which(CD_mobility$date.x=='2020-04-21'), ]
CD_cov19.0422 = CD_mobility[ which(CD_mobility$date.x=='2020-04-22'), ]
CD_cov19.0423 = CD_mobility[ which(CD_mobility$date.x=='2020-04-23'), ]
CD_cov19.0424 = CD_mobility[ which(CD_mobility$date.x=='2020-04-24'), ]

cov19.month = merge(x = CD_cov19.0424, y = CD_cov19.0324, by = c("county", "state", "fips", "retail_recreation", "grocery_pharmacy", "parks", "transit_stations", "workplaces", "residential"))

cov19.month$deathmonth = cov19.month$deaths.x - cov19.month$deaths.y
cov19.month$casesmonth = cov19.month$cases.x - cov19.month$cases.y

####
cov19.month$date.x.x = NULL
cov19.month$cases.x = NULL
cov19.month$deaths.x = NULL
cov19.month$date.y.x = NULL
cov19.month$region.x = NULL
cov19.month$date.x.y = NULL
cov19.month$cases.y = NULL
cov19.month$deaths.y = NULL
cov19.month$date.y.y = NULL
cov19.month$region.y = NULL
head(cov19.month)
#### Delete variables, keep mobility ones and change variable
  
allmerged = merge(x=cov19.month, y = data_health, all.x = TRUE, by = c("fips", "county", "state"))
head(allmerged)
  
```

```{r echo = FALSE}

#Used For Picking Better Dates

datasubsets = list(CD_cov19.0329, CD_cov19.0330, CD_cov19.0331, CD_cov19.0401, CD_cov19.0402, CD_cov19.0403, CD_cov19.0404, CD_cov19.0405, CD_cov19.0406, CD_cov19.0407, CD_cov19.0408, CD_cov19.0409, CD_cov19.0410, CD_cov19.0411, CD_cov19.0412, CD_cov19.0413, CD_cov19.0414, CD_cov19.0415, CD_cov19.0416, CD_cov19.0417, CD_cov19.0418, CD_cov19.0419, CD_cov19.0420, CD_cov19.0421, CD_cov19.0422, CD_cov19.0423, CD_cov19.0424)

casesmodels = vector(mode = "list", length = 27)
deathsmodels = vector(mode = "list", length = 27)

index = 1

for (daydata in datasubsets){

  
index = index + 1


}

```

```{r}

## Full Linear Models for Deaths and Cases

cov19_project = subset(allmerged,select=c("casesmonth","deathmonth","percent_low_birthweight","percent_smokers","primary_care_physicians_rate","percent_vaccinated","num_households","average_daily_pm2_5","life_expectancy","child_mortality_rate","infant_mortality_rate","percent_food_insecure","median_household_income","average_traffic_volume_per_meter_of_major_roadways","population_2","percent_65_and_over","percent_rural","percent_uninsured","retail_recreation","grocery_pharmacy","parks","transit_stations","workplaces","residential", "average_traffic_volume_per_meter_of_major_roadways"))

cov19_project_nm = subset(allmerged,select=c("casesmonth","deathmonth","percent_low_birthweight","percent_smokers","primary_care_physicians_rate","percent_vaccinated","num_households","average_daily_pm2_5","life_expectancy","child_mortality_rate","infant_mortality_rate","percent_food_insecure","median_household_income","population_2","percent_65_and_over","percent_rural","percent_uninsured"))

```



## Checking Correlation between variables
```{r}
#based on the output here, we will probably need to log transform casesmonth
ggpairs(cov19_project, columns = c(1, 3:8))
ggpairs(cov19_project, columns = c(1, 9:14))
ggpairs(cov19_project, columns = c(1, 15:18))
ggpairs(cov19_project, columns = c(1, 19:25))
```

```{r}
#based on the output here, we will probably need to log transform casesmonth
ggpairs(cov19_project, columns = c(2, 3:8))
ggpairs(cov19_project, columns = c(2, 9:14))
ggpairs(cov19_project, columns = c(2, 15:18))
ggpairs(cov19_project, columns = c(2, 19:25)) # mobility variables
```



```{r}
library(car)

boxcoxtestreg = lm(data = na.omit(cov19_project_nm), casesmonth ~ life_expectancy + percent_vaccinated + percent_rural )
bc = boxCox(boxcoxtestreg)

lambda.opt = bc$x[which.max(bc$y)]
lambda.opt

#Confirms that log transform is the best for cases

cov19_project_nm$logcasesmonth = log(cov19_project_nm$casesmonth)

```

```{r}

cov19_project_nm$householdspercapita = cov19_project_nm$num_households/cov19_project_nm$population_2
cov19_project_nm$majorityruralfactor = ifelse(cov19_project_nm$percent_rural > .5, 1, 0)


```


```{r}

mod0.lower_cases = lm(data = na.omit(cov19_project_nm), logcasesmonth ~ 1)
mod0.upper_cases = lm(data = na.omit(cov19_project_nm), logcasesmonth ~  percent_low_birthweight +percent_smokers +primary_care_physicians_rate +percent_vaccinated + householdspercapita +average_daily_pm2_5 +life_expectancy +child_mortality_rate +infant_mortality_rate +percent_food_insecure +median_household_income +percent_65_and_over +majorityruralfactor +percent_uninsured)
step(mod0.lower_cases, scope = list(lower = mod0.lower_cases, upper = mod0.upper_cases))


lm1 = lm(data = na.omit(cov19_project_nm), logcasesmonth ~  percent_low_birthweight +percent_smokers +primary_care_physicians_rate + householdspercapita +average_daily_pm2_5 +life_expectancy +infant_mortality_rate +median_household_income +percent_65_and_over +majorityruralfactor)

shapiro.test(residuals(lm1))

plot(y = residuals(lm1), x = fitted(lm1))
plot(y = residuals(lm1), x = na.omit(cov19_project_nm)$percent_low_birthweight)
#Concentrated on left, log transform var
cov19_project_nm$log_percent_low_birthweight = log(cov19_project_nm$percent_low_birthweight)

lm2 = lm(data = na.omit(cov19_project_nm), logcasesmonth ~  percent_low_birthweight +percent_smokers +primary_care_physicians_rate + householdspercapita +average_daily_pm2_5 +life_expectancy +infant_mortality_rate +median_household_income +percent_65_and_over +majorityruralfactor)

shapiro.test(residuals(lm2))
plot(y=residuals(lm2), x= na.omit(cov19_project_nm)$log_percent_low_birthweight)

plot(y=residuals(lm2), x= )


```

```{r}

mod1.initial = lm(data = na.omit(cov19_project_nm), logcasesmonth ~ median_household_income)
plot(data = na.omit(cov19_project_nm), x = fitted(mod1.initial), y = residuals(mod1.initial))
#Concentrated on left, possibly transform var
cov19_project_nm$log_median_household_income = log(cov19_project_nm$median_household_income)

mod1.test1 = lm(data = na.omit(cov19_project_nm), logcasesmonth ~ log_median_household_income)
plot(data = na.omit(cov19_project_nm), x = fitted(mod1.test1), y = residuals(mod1.test1))
hist(data = na.omit(cov19_project_nm), residuals(mod1.test1)) #normally dist

mod1.lower_cases = mod1.test1
mod1.upper_cases = lm(data = na.omit(cov19_project_nm), logcasesmonth ~  percent_low_birthweight +percent_smokers +primary_care_physicians_rate +percent_vaccinated + householdspercapita +average_daily_pm2_5 +life_expectancy +child_mortality_rate +infant_mortality_rate +percent_food_insecure + log_median_household_income +percent_65_and_over +majorityruralfactor +percent_uninsured)

step(mod1.lower_cases, scope = list(lower = mod1.lower_cases, upper = mod1.upper_cases))


```