---
title: "STAT510_Project"
author: "Nicholas Roy"
date: "4/22/2020"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

```

```{r, echo=FALSE} 
pkgs = c("alr4","rmarkdown", "faraway", "datasets", "sos", "car", "plotly", "ggplot2", "tidyverse", "broom", "SemiPar", "RegularExpressions","GGally", "leaps", "usmap", "maps", "plotly", "devtools", "stargazer", "MASS")
new.packages = pkgs[!(pkgs %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

library(GGally)
library(ggplot2)
```

```{r}
##Working Directory
#setwd("C:\Users\mnhale\OneDrive - Urban Science\STATS\Spring 2020\STAT 510\covidanalysis\project")

#setwd("C:/Users/Nicho/OneDrive/2_Mathematics/School/courses/STAT510_intro_regression_analysis/project/github/covidanalysis/project")
```

#Data Preparation

##Step 1: Import Raw Datasets

```{r}

#casesanddeaths = read.csv(file = "csvs/us-counties.csv")
casesanddeaths = read.csv(url("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv"))
data_health = read.csv(file = "csvs/us-county-health-rankings-2020.csv")
SAHorder = read.csv(file = "csvs/state-stay-home.csv")
global_mobility = read.csv(file = "csvs/Global_Mobility_Report.csv")
#global_mobility = read.csv(url("https://www.gstatic.com/covid19/mobility/Global_Mobility_Report.csv?cachebust=a88b56a24e1a1e25"))

#***REMOVE ONCE NEW DATA IS WORKING***
data_mobility_old = read.csv(file = "csvs/us-mobility.csv")
data_mobility_old$county = stringr::str_remove(data_mobility$region, " County")
#***REMOVE ONCE NEW DATA IS WORKING***

```


##Step 2: Create US County Level Data
```{r}

#Clean
us_mobility = global_mobility

#Remove Non-US Countries
othercountries<-which(us_mobility$country_region_code!="US")
us_mobility<-us_mobility[-othercountries,]

#Remove Observations with Missing Country Data
nacountries<-which(is.na(us_mobility$country_region_code))
us_mobility<-us_mobility[-nacountries,]

```

##Step 3: Remove non SAH states

For this class we are limited to cross-sectional analysis. To address the inherent time-series nature of this data, we are going to perform a transformation that simplifies the data to a 4 week period and only looks at states that stayed at home. Because each state implemented the stay at home orders at different times, our observations are simplified to the change over the 4 week period immediately following the stay at home orders. According to the <a href="https://www.kff.org/other/slide/when-state-stay-at-home-orders-due-to-coronavirus-went-into-effect/"> Kaiser Family Foundation (KFF) </a>, Missouri and South Carolina were the last states to implement these orders on April 7th, 2020. We used the timeline from KFF to determine our observation period. Note according to <a href="https://www.usatoday.com/story/news/nation/2020/03/30/coronavirus-stay-home-shelter-in-place-orders-by-state/5092413002/"> USA Today </a> , we see that Wyoming, Utah, South Dakota, Oklahoma, North Dakota, Nebraska, Iowa, and Arkansas have not declared stay at home orders. Since these states have very few counties and cases, we will be excluding them from the mobility data prior to the analysis as they could be potential outliers. This only applies for the mobility variables as they are they are the only independent variables that are most likely to be affected by stay at home orders. The health variables are based on pre-pandemic data and thus will not suffer from this issue. For the dependent variable we look at the 4 week change in cases/population after the most day following the most recent statewide order in the nation (4/8/20). A separate analysis excluding these states will also be included.


```{r}
#Remove non SAH states

nonSAH_states = which(us_mobility$sub_region_1 == "Wyoming" | us_mobility$sub_region_1 == "Utah" | us_mobility$sub_region_1 == "South Dakota" | us_mobility$sub_region_1 == "Oklahoma" |us_mobility$sub_region_1 == "North Dakota" | us_mobility$sub_region_1 == "Nebraska" |us_mobility$sub_region_1 == "Iowa" | us_mobility$sub_region_1 == "Arkansas") #States w/ no stay at home order

us_mobility<-us_mobility[-nonSAH_states,]

```


##Step 4: Merge Mobility & Case Data
```{r}

#Clean Mobility Data to Merge w/ COVID Data
us_mobility$state = us_mobility$sub_region_1
us_mobility$county = stringr::str_remove(us_mobility$sub_region_2, " County")

CD_mobility = merge(x = casesanddeaths, y = us_mobility, all.x = TRUE, by = c("county", "state", "date"))

```

##Step 5: Adjust data based on "Stay at Home" orders

```{r}

SAHdates_withdata = merge(x = CD_mobility, y = SAHorder, all.x=TRUE, by.x = "state", by.y = "STATE")

#Get rid of pre stay at home order dates
earlydates = which(as.integer(as.Date(SAHdates_withdata$date)) < as.integer(as.Date("2020-03-18")))
SAHdates_withdata2 = SAHdates_withdata[-earlydates,]

#Focus on key dates
unimportant_dates = which(as.Date(SAHdates_withdata2$date) != as.Date(SAHdates_withdata2$EFF_DATE) & (as.Date(SAHdates_withdata2$date) - as.Date(SAHdates_withdata2$EFF_DATE) != 28)) #Only have dates for a state based on day of stay at home order and 3 weeks after.
impdates = SAHdates_withdata2[-unimportant_dates,]

pseudoSAH_dates =  which((impdates$date != "2020-04-08" & impdates$date != "2020-05-06") & (impdates$state == "Wyoming" | impdates$state == "Utah" | impdates$state == "South Dakota" | impdates$state == "Oklahoma" | impdates$state == "North Dakota" | impdates$state == "Nebraska" |impdates$state == "Iowa" | impdates$state == "Arkansas" |impdates$state == "Guam" | impdates$state == "Northern Mariana Islands" | impdates$state == "Puerto Rico" | impdates$state == "Virgin Islands")) #For locations where we don't have SAHOrder data

twodatesastate = impdates[-pseudoSAH_dates,]
```

##Step 6: Make variables differences over the past month to make cross sectional dataset from time-series.

```{r}
#Generating differences
sorteddata = twodatesastate[order(as.integer(twodatesastate$fips), as.Date(twodatesastate$date)),] #sort by fips and date
head(sorteddata)

require("data.table")
sorteddata <- data.table(sorteddata)
sorteddata[, case_change := c(NA,diff(cases)), by="fips"]
sorteddata[, retail_and_rec_pctpoint_change := c(NA,diff(retail_and_recreation_percent_change_from_baseline)), by="fips"]
sorteddata[, grocery_and_pharmacy_pctpoint_change := c(NA,diff(grocery_and_pharmacy_percent_change_from_baseline)), by="fips"]
sorteddata[, parks_pctpoint_change := c(NA,diff(parks_percent_change_from_baseline)), by="fips"]
sorteddata[, transit_stations_pctpoint_change := c(NA,diff(transit_stations_percent_change_from_baseline)), by="fips"]
sorteddata[, workplaces_pctpoint_change := c(NA,diff(workplaces_percent_change_from_baseline)), by="fips"]
sorteddata[, residential_pctpoint_change := c(NA,diff(residential_percent_change_from_baseline)), by="fips"]

missingcasedata = which(is.na(sorteddata$case_change))
finalobs = sorteddata[-missingcasedata,]

```

##Step7: Add Health Variables and Normalize Case Change

```{r}

allmerged = merge(x=finalobs, y = data_health, all.x = TRUE, by = "fips")
allmerged$case_change_percapita1 = allmerged$case_change / allmerged$population
allmerged$state = allmerged$state.x

```


##Step8: Make datasets with variables of interest.
```{r}

## Full Linear Models for Cases

alldata = subset(allmerged, select=c("fips","state","case_change_percapita1","percent_low_birthweight","percent_smokers","primary_care_physicians_rate","percent_vaccinated","num_households","average_daily_pm2_5","life_expectancy","child_mortality_rate","infant_mortality_rate","percent_food_insecure","median_household_income","average_traffic_volume_per_meter_of_major_roadways","population_2","percent_65_and_over","percent_rural","percent_uninsured","workplaces_pctpoint_change", "retail_and_rec_pctpoint_change","grocery_and_pharmacy_pctpoint_change","parks_pctpoint_change","transit_stations_pctpoint_change","residential_pctpoint_change", "average_traffic_volume_per_meter_of_major_roadways"))

healthsubset = subset(allmerged,select=c("fips","state","case_change_percapita1","percent_low_birthweight","percent_smokers","primary_care_physicians_rate","percent_vaccinated","num_households","average_daily_pm2_5","life_expectancy","child_mortality_rate","infant_mortality_rate","percent_food_insecure","median_household_income","population_2","percent_65_and_over","percent_rural","percent_uninsured"))

#For checking which mobility variable will be og greatest interest
# summary(alldata$retail_and_rec_pctpoint_change)
# summary(alldata$grocery_and_pharmacy_pctpoint_change) 
# summary(alldata$parks_pctpoint_change)
# summary(alldata$transit_stations_pctpoint_change)
# summary(alldata$workplaces_pctpoint_change)
# summary(alldata$residential_pctpoint_change)

```



## Step 9: Check Correlation between variables and also linearity between independent variables and the dependent variable
```{r}
#based on the output here, we will probably need to log transform casesmonth
ggpairs(healthsubset, columns = c(3, 5:9))
ggpairs(healthsubset, columns = c(3, 10:14))
ggpairs(healthsubset, columns = c(3, 14:18))
#head(cov19_project_nm)
```

We can see that there is non-normality of the case change per capita variable. We will likely log transform this variable. Immdiately we see some variables have unequal variance, but we will perform variable selection before making any transformations.

As far as variables that are collinear, we make the following observations:
We see that life expectancy is collinear with many of the variables. This is to be expected since it is a more general term that is determined by the other variables.This wouldn't be useful as an interaction term, so we will look at the scatterplot matrix of variables correlated with life expectancy.


## Step 10: Look at coorelation with life expectancy.


```{r}
ggpairs(healthsubset, columns = c(10, 5,11,12))
#head(cov19_project_nm)
```

Based off this information we can see that median household income might be the interaction with these variables. Life expectancy could be collinear with percent smokers and percent food insecure, but applying our variable selection criteria should remove the variable with the least amount of explanatory power.

## Step 11: Use Box-cox method to determine best transformation for the dependent variable. The variable tempcases is simply to be positive to prevent errors for the box cox transformation

```{r}
library(car)

summary(healthsubset$case_change_percapita1)


healthsubset$tempcases = healthsubset$case_change_percapita1 + .00084

boxcoxtestreg = lm(data = na.omit(healthsubset), tempcases ~  percent_low_birthweight +percent_smokers +primary_care_physicians_rate + num_households +average_daily_pm2_5 +life_expectancy +infant_mortality_rate +median_household_income +percent_65_and_over + percent_rural )

bc = boxCox(boxcoxtestreg)

lambda.opt = bc$x[which.max(bc$y)]
lambda.opt

#Confirms that log transform is the best for cases

healthsubset$logcasechange = log(healthsubset$case_change_percapita1 + .0084)

```

From the box-cox method, we can see that a log transformation is most appropriate.

## Step 12: We can now do variable selection using the AIC variable selection criteria.

```{r}

mod0.lower_cases = lm(data = na.omit(healthsubset), logcasechange ~ 1)
mod0.upper_cases = lm(data = na.omit(healthsubset), logcasechange ~  percent_low_birthweight +percent_smokers +primary_care_physicians_rate +percent_vaccinated + num_households +average_daily_pm2_5 +life_expectancy +child_mortality_rate +infant_mortality_rate +percent_food_insecure +median_household_income +percent_65_and_over +percent_rural +percent_uninsured)
step(mod0.lower_cases, scope = list(lower = mod0.lower_cases, upper = mod0.upper_cases))

```

## Step 13: We now have the base model for what variables we will be using. Now we must check the 4 assumptions of Multiple Linear Regression: Linearity, Independence, Normality, and Equal Variance

```{r}

lm1 = lm(formula = logcasechange ~ percent_low_birthweight + median_household_income + percent_food_insecure + percent_rural + average_daily_pm2_5 + percent_uninsured + child_mortality_rate, data = na.omit(healthsubset))

shapiro.test(residuals(lm1)) ## We fail the shapiro test. So the present model fails the normality assumption. Let us examine the residuals vs. fit plot first.

plot(y = residuals(lm1), x = fitted(lm1)) #We don't see a terrible issue with the variance, but there is some of a fanning pattern. We will now check the residuals vs. the variables to see if we can resolve this issue with some variable transformations.

plot(y = residuals(lm1), x = na.omit(healthsubset)$percent_low_birthweight) #Concentrated on left, log transform var
healthsubset$log_percent_low_birthweight = log(healthsubset$percent_low_birthweight)

lm2 = lm(formula = logcasechange ~ log_percent_low_birthweight + median_household_income + percent_food_insecure + percent_rural + average_daily_pm2_5 + percent_uninsured + child_mortality_rate, data = na.omit(healthsubset))

plot(y=residuals(lm2), x= na.omit(healthsubset)$log_percent_low_birthweight) #This is a significant improvement from the previous scatterplot.

plot(y=residuals(lm2), x= na.omit(healthsubset)$median_household_income) #Needs log transform
healthsubset$log_median_household_income = log(healthsubset$median_household_income)

lm3 = lm(formula = logcasechange ~ log_percent_low_birthweight + log_median_household_income + percent_food_insecure + percent_rural + average_daily_pm2_5 + percent_uninsured + child_mortality_rate, data = na.omit(healthsubset))

plot(y=residuals(lm3), x= na.omit(healthsubset)$log_median_household_income) #This is a significant improvement from the previous scatterplot.

plot(y=residuals(lm3), x= na.omit(healthsubset)$percent_food_insecure) #Needs log transform
healthsubset$log_percent_food_insecure = log(healthsubset$percent_food_insecure)

lm4 = lm(formula = logcasechange ~ log_percent_low_birthweight + log_median_household_income + log_percent_food_insecure + percent_rural + average_daily_pm2_5 + percent_uninsured + child_mortality_rate, data = na.omit(healthsubset))

plot(y=residuals(lm4), x= na.omit(healthsubset)$log_percent_food_insecure) #This is a significant improvement

plot(y=residuals(lm4), x= na.omit(healthsubset)$percent_rural) #While there is a slight degree of funnelling, the variance looks mostly equal. Especially when compared to the other variables

plot(y=residuals(lm4), x= na.omit(healthsubset)$average_daily_pm2_5) #Needs log transform
healthsubset$log_average_daily_pm2_5 = log(healthsubset$average_daily_pm2_5)

lm5 = lm(formula = logcasechange ~ log_percent_low_birthweight + log_median_household_income + log_percent_food_insecure + percent_rural + log_average_daily_pm2_5 + percent_uninsured + child_mortality_rate, data = na.omit(healthsubset)) 

plot(y=residuals(lm5), x= na.omit(healthsubset)$log_average_daily_pm2_5) #This isn't perfect, but it is an improvement from the previous plot.

plot(y=residuals(lm5), x= na.omit(healthsubset)$percent_uninsured) #Slight funnelling pattern that is stronger than the percent_rural pattern. Will need a log transform.

healthsubset$log_percent_uninsured = log(healthsubset$percent_uninsured)

lm6 = lm(formula = logcasechange ~ log_percent_low_birthweight + log_median_household_income + log_percent_food_insecure + percent_rural + log_average_daily_pm2_5 + log_percent_uninsured + child_mortality_rate, data = na.omit(healthsubset)) 

plot(y=residuals(lm6), x= na.omit(healthsubset)$log_percent_uninsured) #Equal variance problem solved.

plot(y=residuals(lm6), x= na.omit(healthsubset)$child_mortality_rate) #Needs log transform

healthsubset$log_child_mortality_rate = log(healthsubset$child_mortality_rate)

lm7 = lm(formula = logcasechange ~ log_percent_low_birthweight + log_median_household_income + log_percent_food_insecure + percent_rural + log_average_daily_pm2_5 + log_percent_uninsured + log_child_mortality_rate, data = na.omit(healthsubset)) 

plot(y=residuals(lm7), x= na.omit(healthsubset)$log_child_mortality_rate) #Equal variance issue solved

shapiro.test(residuals(lm7))

summary(lm7)

```

Unfortunately this did not solve our normality issue.

```{r}
ggpairs(data = na.omit(healthsubset), columns = c("log_percent_low_birthweight", "log_median_household_income", "log_percent_food_insecure", "percent_rural", "log_average_daily_pm2_5", "log_percent_uninsured", "log_child_mortality_rate"))

##Percent rural might be better log transformed
healthsubset$log_percent_rural = log(healthsubset$percent_rural + 1) #add +1 for locations with 0 values

lm8 = lm(formula = logcasechange ~ log_percent_low_birthweight + log_median_household_income + log_percent_food_insecure + log_percent_rural + log_average_daily_pm2_5 + log_percent_uninsured + log_child_mortality_rate, data = na.omit(healthsubset)) 

plot(y=residuals(lm8), x= na.omit(healthsubset)$log_percent_rural) #Fairly equal variance

shapiro.test(residuals(lm8)) #Normality still not solved.


plot(y=residuals(lm8), x= fitted(lm8))
```

The transformations didn't change our residual vs fit plot or our normality issues. We will implement run some interaction terms through variable selection to see if they normalize our model.


### Add Variables We Previously had back into the model.

## Step 14: Test Potential Interaction Effects

```{r}
library(MASS)
lm8interactions = stepAIC(lm8, scope=list(upper= ~log_percent_low_birthweight*log_median_household_income*log_percent_food_insecure*log_percent_rural*log_average_daily_pm2_5*log_percent_uninsured*log_child_mortality_rate, lower= ~1))

shapiro.test(residuals(lm8interactions))


ggpairs(data = na.omit(healthsubset), columns = c("log_percent_low_birthweight", "log_median_household_income", "log_percent_food_insecure", "log_percent_rural", "log_average_daily_pm2_5", "log_percent_uninsured", "log_child_mortality_rate"))

#interaction terms

#majority rural and other factors
mod1.lower_cases = lm(data = na.omit(cov19_project_nm), logcasesmonth ~  log_percent_low_birthweight + percent_smokers +log_primary_care_physicians_rate +average_daily_pm2_5 +life_expectancy +log_infant_mortality_rate +log_median_household_income + log_percent_65_and_over +majorityruralfactor)

mod1.upper_cases = lm(data = na.omit(cov19_project_nm), logcasesmonth ~  log_percent_low_birthweight + percent_smokers +log_primary_care_physicians_rate +average_daily_pm2_5 +life_expectancy +log_infant_mortality_rate +log_median_household_income + log_percent_65_and_over +majorityruralfactor+log_percent_low_birthweight*majorityruralfactor + percent_smokers*majorityruralfactor +log_primary_care_physicians_rate*majorityruralfactor +average_daily_pm2_5*majorityruralfactor +life_expectancy*majorityruralfactor +log_infant_mortality_rate*majorityruralfactor +log_median_household_income*majorityruralfactor + log_percent_65_and_over*majorityruralfactor)

step(mod1.lower_cases, scope = list(lower = mod1.lower_cases, upper = mod1.upper_cases))

# median HH income and other factors
mod2.lower_cases = lm(data = na.omit(cov19_project_nm), logcasesmonth ~  log_percent_low_birthweight + percent_smokers +log_primary_care_physicians_rate +average_daily_pm2_5 +life_expectancy +log_infant_mortality_rate +log_median_household_income + log_percent_65_and_over +majorityruralfactor)

mod2.upper_cases = lm(data = na.omit(cov19_project_nm), logcasesmonth ~  log_percent_low_birthweight + percent_smokers +log_primary_care_physicians_rate +average_daily_pm2_5 +life_expectancy +log_infant_mortality_rate +log_median_household_income + log_percent_65_and_over +majorityruralfactor+log_percent_low_birthweight*log_median_household_income + percent_smokers*log_median_household_income +log_primary_care_physicians_rate*log_median_household_income +average_daily_pm2_5*log_median_household_income +life_expectancy*log_median_household_income +log_infant_mortality_rate*log_median_household_income + log_percent_65_and_over*log_median_household_income)

step(mod2.lower_cases, scope = list(lower = mod2.lower_cases, upper = mod2.upper_cases))

```





```{r}

#normality issue
#remove potential outliers (no time to use influential point methods)


plot(lm8, which = 2)
plot(residuals(lm8), fitted(lm8))

cov19_project_nm_nooutliers = na.omit(cov19_project_nm)
cov19_project_nm_nooutliers$lm8resids = na.omit(residuals(lm8))

outliers = boxplot(cov19_project_nm_nooutliers$lm8resids, plot=FALSE)$out

lm8resids = append(outliers, 5:925, after = length(outliers) - 1)

outliermarker = rep(1,length(cov19_project_nm_nooutliers))
outliermat = as.data.frame(cbind(lm8resids, outliermarker))

cov19_project_nm_nooutliers = merge(x = cov19_project_nm_nooutliers, y = outliermat, by = "lm8resids", all.x = TRUE)

cov19_project_nm_nooutliers<- cov19_project_nm_nooutliers[-which(cov19_project_nm_nooutliers$outliermarker == 1),]


lm9 = lm(data = cov19_project_nm_nooutliers, logcasesmonth ~  log_percent_low_birthweight + percent_smokers +log_primary_care_physicians_rate +average_daily_pm2_5 +life_expectancy +log_infant_mortality_rate +log_median_household_income + log_percent_65_and_over +majorityruralfactor)

plot(lm9, which = 2)

shapiro.test(residuals(lm9))
hist(residuals(lm9))

```

```{r}
library(usmap)
ggplot(data = cov19_project_nm, aes(log_percent_65_and_over, logcasesmonth, col = factor(state)))+
  geom_point()+
  labs(title = "Scatterplot Log(% over 65) vs. Log(Cases Month)",
  x = "Log(% over 65)",
  y= "Log(Cases Month)")

states = cov19_project_nm$STATE


plot_usmap(regions = c("states"), data = cov19_project_nm,
           values = "casesmonth", color = "light gray", labels = FALSE,
           label_color = "black") + scale_fill_continuous(low = "pink", high = "red", na.value = " gray", name ="", label = scales::comma) +
  theme(legend.key.width = unit(2, "line"), legend.key.height = unit(3, "line"), legend.position = "right", legend.title = element_text(size=16))

help(plot_usmap)
```


```{r}
#prediction interval for counties with 65+
fit2 = lm(logcasesmonth ~ log_percent_low_birthweight + percent_smokers + 
    log_primary_care_physicians_rate + average_daily_pm2_5 + 
    life_expectancy + log_infant_mortality_rate + log_median_household_income + 
    log_percent_65_and_over + majorityruralfactor + log_median_household_income:log_percent_65_and_over + 
    log_median_household_income:majorityruralfactor + log_percent_low_birthweight:log_median_household_income + 
    percent_smokers:log_median_household_income + life_expectancy:log_median_household_income, 
    data = na.omit(cov19_project_nm))
summary(fit1)
summary(fit2)

#looks like relatively equal variance on the right side
x10 = na.omit(cov19_project_nm)$log_median_household_income*na.omit(cov19_project_nm)$majorityruralfactor
plot(x = x10, y= na.omit(cov19_project_nm)$logcasesmonth,cex.axis = .6, xlab = "", ylab = "")
title(xlab = "log(Med HH Income)*majority rural", line = 2, cex.lab = .7)
title(ylab = "log(cases month)", line=2, cex.lab = .7)
title(main = "log(Med HH Income)*majority rural vs. log(cases month)",line = 0.5, cex.lab = .5 )


x11 = na.omit(cov19_project_nm)$log_median_household_income*na.omit(cov19_project_nm)$log_percent_low_birthweight
plot(x = x11, y= na.omit(cov19_project_nm)$logcasesmonth,cex.axis = .6, xlab = "", ylab = "")
title(xlab = "log(Med HH Income)*log(% low birth weight)", line = 2, cex.lab = .7)
title(ylab = "log(cases month)", line=2, cex.lab = .7)
title(main = "log(Med HH Income)*log(% low birth weight) vs. log(cases month)",line = 0.5, cex.lab = .5 )


x12 = na.omit(cov19_project_nm)$log_median_household_income*na.omit(cov19_project_nm)$percent_smokers
plot(x = x12, y= na.omit(cov19_project_nm)$logcasesmonth,cex.axis = .6, xlab = "", ylab = "")
title(xlab = "log(Med HH Income)*percent smokers", line = 2, cex.lab = .7)
title(ylab = "log(cases month)", line=2, cex.lab = .7)
title(main = "log(Med HH Income)*percent_smokers vs. log(cases month)",line = 0.5, cex.lab = .5 )

x13 = na.omit(cov19_project_nm)$log_median_household_income*na.omit(cov19_project_nm)$life_expectancy
plot(x = x13, y= na.omit(cov19_project_nm)$logcasesmonth,cex.axis = .6, xlab = "", ylab = "")
title(xlab = "log(Med HH Income)*life_expectancy", line = 2, cex.lab = .7)
title(ylab = "log(cases month)", line=2, cex.lab = .7)
title(main = "log(Med HH Income)*life_expectancy vs. log(cases month)",line = 0.5, cex.lab = .5 )

```


```{r}
#mobility
cov19_project$logcasesmonth = cov19_project_nm$logcasesmonth
cov19_project$log_percent_low_birthweight = log(cov19_project$percent_low_birthweight)
cov19_project$log_primary_care_physicians_rate = log(cov19_project$primary_care_physicians_rate)
cov19_project$log_infant_mortality_rate = log(cov19_project$infant_mortality_rate)
cov19_project$log_median_household_income = log(cov19_project$median_household_income)
cov19_project$log_percent_65_and_over = log(cov19_project$percent_65_and_over)
cov19_project$majorityruralfactor = ifelse(cov19_project_nm$percent_rural > .5, 1, 0)


lm8 = lm(data = na.omit(cov19_project_nm), logcasesmonth ~  log_percent_low_birthweight + percent_smokers +log_primary_care_physicians_rate + average_daily_pm2_5 + life_expectancy + log_infant_mortality_rate +log_median_household_income + log_percent_65_and_over + majorityruralfactor)

fit2 = lm(logcasesmonth ~ log_percent_low_birthweight + percent_smokers + 
    log_primary_care_physicians_rate + average_daily_pm2_5 + 
    life_expectancy + log_infant_mortality_rate + log_median_household_income + 
    log_percent_65_and_over + majorityruralfactor + log_median_household_income:log_percent_65_and_over + 
    log_median_household_income:majorityruralfactor + log_percent_low_birthweight:log_median_household_income + 
    percent_smokers:log_median_household_income + life_expectancy:log_median_household_income, 
    data = na.omit(cov19_project_nm))

fit2_alt = lm(logcasesmonth ~ log_percent_low_birthweight + percent_smokers + 
    log_primary_care_physicians_rate + average_daily_pm2_5 + 
    life_expectancy + log_infant_mortality_rate + log_median_household_income + 
    log_percent_65_and_over + majorityruralfactor + log_median_household_income:log_percent_65_and_over + 
    log_median_household_income:majorityruralfactor + log_percent_low_birthweight:log_median_household_income + 
    percent_smokers:log_median_household_income + life_expectancy:log_median_household_income, 
    data = na.omit(cov19_project))

fit2mobility = lm(data = na.omit(cov19_project), logcasesmonth ~ log_percent_low_birthweight + percent_smokers + 
    log_primary_care_physicians_rate + average_daily_pm2_5 + 
    life_expectancy + log_infant_mortality_rate + log_median_household_income + 
    log_percent_65_and_over + majorityruralfactor + log_median_household_income:log_percent_65_and_over + 
    log_median_household_income:majorityruralfactor + log_percent_low_birthweight:log_median_household_income + 
    percent_smokers:log_median_household_income + life_expectancy:log_median_household_income + retail_recreation + grocery_pharmacy +parks + transit_stations + workplaces + residential)

shapiro.test(residuals(fit2))
shapiro.test(residuals(fit2mobility))

plot(fit2, which = 2)
hist(residuals(fit2), main = "Histogram of Model Residuals", xlab = "Standardized Residuals")

anova(fit2_alt, fit2mobility)
summary(lm8)
summary(fit2)
summary(fit2mobility)
library(stargazer)
help(stargazer)
table = stargazer(lm8, fit2, fit2mobility, title = "Results", align = TRUE, type ="html")

```

```{r}
plot(y=residuals(fit2), x= x10) #fixes unequal variance

p.i. = predict(fit2, interval = 'confidence', level = .95)
confint(fit2, "log_percent_65_and_over",level = .95)
summary(fit2)

mean(cov19_project$deathmonth)
```

